import React, { useState, useEffect } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import { auth } from "../services/firebase";
import {
  getFirestore,
  collection,
  addDoc,
  serverTimestamp,
} from "firebase/firestore";
import AudioRecorder from "../components/AudioRecorder";
import { aiService } from "../services/aiService";

interface Drawing {
  id: string;
  imageData: string;
  title: string;
  description: string;
}

const CreateStoryForm: React.FC = () => {
  const location = useLocation();
  const navigate = useNavigate();
  const [title, setTitle] = useState("");
  const [content, setContent] = useState("");
  const [genre, setGenre] = useState("");
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [audioData, setAudioData] = useState<string | null>(null);
  const drawing = location.state?.drawing as Drawing;
  const [aiSuggestions, setAiSuggestions] = useState<any>(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);

  useEffect(() => {
    // Sayfa y√ºklendiƒüinde modeli y√ºkle
    const loadModel = async () => {
      try {
        await aiService.loadModel();
      } catch (error) {
        console.error("Model y√ºklenirken hata olu≈ütu:", error);
      }
    };
    loadModel();
  }, []);

  useEffect(() => {
    if (!drawing) {
      navigate("/create-story");
    }
  }, [drawing, navigate]);

  const handleAnalyzeDrawing = async () => {
    if (!drawing?.imageData) {
      alert("Analiz edilecek √ßizim bulunamadƒ±!");
      return;
    }

    try {
      console.log("üöÄ Analiz i≈ülemi ba≈ülatƒ±lƒ±yor...");
      setIsAnalyzing(true);

      // G√∂r√ºnt√ºy√º y√ºkle
      const image = new Image();
      image.crossOrigin = "anonymous"; // CORS hatasƒ±nƒ± √∂nlemek i√ßin

      // G√∂r√ºnt√º y√ºkleme hatalarƒ±nƒ± yakala
      image.onerror = (error) => {
        console.error("‚ùå G√∂r√ºnt√º y√ºklenirken hata olu≈ütu:", error);
        alert("G√∂r√ºnt√º y√ºklenirken bir hata olu≈ütu. L√ºtfen tekrar deneyin.");
        setIsAnalyzing(false);
      };

      // G√∂r√ºnt√º y√ºklendiƒüinde analiz et
      image.onload = async () => {
        try {
          console.log("üì∏ G√∂r√ºnt√º y√ºklendi, analiz ba≈ülƒ±yor...");
          console.log("üìê G√∂r√ºnt√º boyutlarƒ±:", image.width, "x", image.height);

          // G√∂r√ºnt√º boyutlarƒ±nƒ± kontrol et
          if (image.width === 0 || image.height === 0) {
            throw new Error("Ge√ßersiz g√∂r√ºnt√º boyutlarƒ±!");
          }

          // G√∂r√ºnt√ºy√º canvas'a √ßiz
          const canvas = document.createElement("canvas");
          canvas.width = image.width;
          canvas.height = image.height;
          const ctx = canvas.getContext("2d");

          if (!ctx) {
            throw new Error("Canvas context olu≈üturulamadƒ±!");
          }

          ctx.drawImage(image, 0, 0);
          console.log("üé® G√∂r√ºnt√º canvas'a √ßizildi");

          // Analiz i≈ülemlerini yap
          const analysis = await aiService.analyzeDrawing(image);
          const storyPrompt = await aiService.generateStoryPrompt(analysis);
          const suggestions = await aiService.suggestStoryElements(analysis);

          setAiSuggestions(suggestions);
          setContent(storyPrompt);
          console.log("‚úÖ Analiz i≈ülemi ba≈üarƒ±yla tamamlandƒ±!");
        } catch (error) {
          console.error("‚ùå Analiz sƒ±rasƒ±nda hata olu≈ütu:", error);
          alert(
            "√áizim analiz edilirken bir hata olu≈ütu. L√ºtfen tekrar deneyin."
          );
        } finally {
          setIsAnalyzing(false);
        }
      };

      // G√∂r√ºnt√ºy√º y√ºklemeye ba≈üla
      image.src = drawing.imageData;
    } catch (error) {
      console.error("‚ùå Analiz ba≈ülatƒ±lƒ±rken hata olu≈ütu:", error);
      alert("Analiz ba≈ülatƒ±lƒ±rken bir hata olu≈ütu. L√ºtfen tekrar deneyin.");
      setIsAnalyzing(false);
    }
  };

  const handleAudioRecorded = async (audioBlob: Blob) => {
    try {
      const reader = new FileReader();
      reader.readAsDataURL(audioBlob);
      reader.onloadend = () => {
        const base64Audio = reader.result as string;
        setAudioData(base64Audio);
      };
    } catch (error) {
      console.error("Ses kaydƒ± i≈ülenirken hata:", error);
      alert("Ses kaydƒ± i≈ülenirken bir hata olu≈ütu.");
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!title.trim() || !content.trim() || !genre.trim()) {
      alert("L√ºtfen t√ºm alanlarƒ± doldurun!");
      return;
    }

    try {
      setIsSubmitting(true);
      const user = auth.currentUser;
      if (!user) {
        alert("L√ºtfen √∂nce giri≈ü yapƒ±n");
        return;
      }

      const db = getFirestore();
      const storiesRef = collection(db, "stories");

      await addDoc(storiesRef, {
        userId: user.uid,
        title,
        content,
        genre,
        drawingId: drawing.id,
        drawingImage: drawing.imageData,
        coverImage: drawing.imageData,
        pages: [
          {
            imageUrl: drawing.imageData,
            text: `√áizim: ${drawing.title}\n\n${drawing.description}\n\nHikaye: ${content}`,
            audioData: audioData,
          },
        ],
        createdAt: serverTimestamp(),
        likes: 0,
        comments: [],
        status: "published",
      });

      alert("Hikaye ba≈üarƒ±yla olu≈üturuldu!");
      navigate("/stories");
    } catch (error) {
      console.error("Hikaye olu≈üturulurken hata olu≈ütu:", error);
      alert("Hikaye olu≈üturulurken bir hata olu≈ütu");
    } finally {
      setIsSubmitting(false);
    }
  };

  if (!drawing) {
    return null;
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100">
      <div className="fixed top-0 left-0 right-0 bg-white/90 backdrop-blur-sm shadow-md z-50 p-4">
        <div className="max-w-7xl mx-auto">
          <div className="flex justify-between items-center">
            <h1 className="text-3xl font-bold text-gray-800">
              Yeni Hikaye Olu≈ütur
            </h1>
            <button
              onClick={() => navigate("/create-story")}
              className="px-4 py-2 text-gray-600 hover:text-gray-800"
            >
              ƒ∞ptal
            </button>
          </div>
        </div>
      </div>

      <div className="pt-24 p-8">
        <div className="max-w-7xl mx-auto">
          <div className="bg-white/90 backdrop-blur-lg rounded-xl p-8 shadow-lg">
            <div className="mb-6 flex justify-end">
              <button
                onClick={handleAnalyzeDrawing}
                disabled={isAnalyzing || !drawing?.imageData}
                className="px-6 py-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition-colors disabled:opacity-50"
              >
                {isAnalyzing ? "Analiz Ediliyor..." : "√áizimi Analiz Et"}
              </button>
            </div>

            {aiSuggestions && (
              <div className="mb-8 p-6 bg-purple-50 rounded-xl">
                <h2 className="text-2xl font-bold text-gray-800 mb-4">
                  AI √ñnerileri
                </h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <div>
                    <h3 className="text-lg font-semibold text-gray-700 mb-2">
                      Karakterler
                    </h3>
                    <ul className="list-disc list-inside">
                      {aiSuggestions.characters.map(
                        (char: string, index: number) => (
                          <li key={index} className="text-gray-600">
                            {char}
                          </li>
                        )
                      )}
                    </ul>
                  </div>
                  <div>
                    <h3 className="text-lg font-semibold text-gray-700 mb-2">
                      Mekan
                    </h3>
                    <p className="text-gray-600">{aiSuggestions.setting}</p>
                  </div>
                  <div>
                    <h3 className="text-lg font-semibold text-gray-700 mb-2">
                      Hikaye
                    </h3>
                    <p className="text-gray-600">{aiSuggestions.plot}</p>
                  </div>
                </div>
              </div>
            )}

            <form onSubmit={handleSubmit} className="space-y-6">
              <div className="bg-white rounded-lg shadow-md overflow-hidden">
                <div className="relative">
                  <img
                    src={drawing.imageData}
                    alt={drawing.title}
                    className="w-full h-64 object-cover"
                  />
                  <div className="absolute top-4 right-4 bg-white/90 px-3 py-1 rounded-full text-sm font-medium text-gray-700">
                    √áizim
                  </div>
                </div>
                <div className="p-4">
                  <h3 className="text-lg font-semibold text-gray-800 mb-2">
                    {drawing.title}
                  </h3>
                  <p className="text-gray-600">{drawing.description}</p>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Hikaye Ba≈ülƒ±ƒüƒ±
                </label>
                <input
                  type="text"
                  value={title}
                  onChange={(e) => setTitle(e.target.value)}
                  placeholder="Hikayenin ba≈ülƒ±ƒüƒ±nƒ± yaz..."
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Hikaye T√ºr√º
                </label>
                <input
                  type="text"
                  value={genre}
                  onChange={(e) => setGenre(e.target.value)}
                  placeholder="Hikayenin t√ºr√ºn√º yaz..."
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Hikaye ƒ∞√ßeriƒüi
                </label>
                <textarea
                  value={content}
                  onChange={(e) => setContent(e.target.value)}
                  placeholder="Hikayeni yaz..."
                  rows={8}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                />
              </div>

              <div>
                <label className="block text-gray-700 mb-2">Ses Kaydƒ±</label>
                <AudioRecorder onAudioRecorded={handleAudioRecorded} />
              </div>

              <div className="flex justify-end">
                <button
                  type="submit"
                  disabled={isSubmitting}
                  className={`px-4 py-2 rounded-lg ${
                    isSubmitting
                      ? "bg-gray-300 cursor-not-allowed"
                      : "bg-purple-500 hover:bg-purple-600"
                  } text-white`}
                >
                  {isSubmitting ? "Olu≈üturuluyor..." : "Hikayeyi Olu≈ütur"}
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      {isAnalyzing && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white p-8 rounded-xl shadow-lg text-center">
            <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-purple-600 mx-auto mb-4"></div>
            <p className="text-xl text-gray-700">
              √áiziminiz analiz ediliyor...
            </p>
          </div>
        </div>
      )}
    </div>
  );
};

export default CreateStoryForm;
